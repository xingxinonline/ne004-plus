#include <math.h>
// #include <stdio.h>
// #include <string.h>
#include <stdint.h>

#include "ooura_fft.h"

static float window_half[256] = {
    0.000000,0.000174,0.000566,0.001127,0.001838,0.002685,0.003660,0.004756,
    0.005968,0.007289,0.008717,0.010248,0.011879,0.013607,0.015429,0.017344,
    0.019349,0.021442,0.023621,0.025885,0.028231,0.030659,0.033167,0.035753,
    0.038416,0.041156,0.043969,0.046856,0.049815,0.052845,0.055944,0.059112,
    0.062348,0.065651,0.069019,0.072452,0.075948,0.079507,0.083127,0.086808,
    0.090549,0.094349,0.098207,0.102121,0.106092,0.110118,0.114198,0.118332,
    0.122519,0.126757,0.131046,0.135385,0.139774,0.144211,0.148695,0.153226,
    0.157803,0.162425,0.167091,0.171801,0.176554,0.181348,0.186183,0.191058,
    0.195973,0.200926,0.205917,0.210945,0.216009,0.221108,0.226242,0.231410,
    0.236611,0.241844,0.247108,0.252403,0.257727,0.263081,0.268463,0.273872,
    0.279307,0.284769,0.290256,0.295766,0.301301,0.306858,0.312437,0.318037,
    0.323657,0.329297,0.334955,0.340632,0.346326,0.352036,0.357761,0.363502,
    0.369257,0.375025,0.380805,0.386597,0.392400,0.398214,0.404037,0.409868,
    0.415707,0.421554,0.427406,0.433265,0.439128,0.444995,0.450865,0.456738,
    0.462613,0.468489,0.474365,0.480240,0.486114,0.491986,0.497856,0.503722,
    0.509583,0.515440,0.521291,0.527135,0.532972,0.538801,0.544622,0.550433,
    0.556234,0.562024,0.567802,0.573569,0.579322,0.585061,0.590786,0.596496,
    0.602190,0.607867,0.613527,0.619169,0.624792,0.630396,0.635980,0.641543,
    0.647084,0.652604,0.658101,0.663574,0.669023,0.674447,0.679846,0.685219,
    0.690565,0.695884,0.701174,0.706436,0.711669,0.716871,0.722043,0.727184,
    0.732293,0.737369,0.742412,0.747422,0.752397,0.757338,0.762242,0.767111,
    0.771943,0.776738,0.781495,0.786214,0.790894,0.795534,0.800134,0.804694,
    0.809212,0.813689,0.818124,0.822515,0.826864,0.831168,0.835429,0.839644,
    0.843814,0.847939,0.852017,0.856048,0.860032,0.863968,0.867856,0.871695,
    0.875485,0.879226,0.882916,0.886556,0.890146,0.893683,0.897169,0.900603,
    0.903985,0.907313,0.910588,0.913810,0.916977,0.920090,0.923147,0.926150,
    0.929097,0.931988,0.934823,0.937601,0.940323,0.942987,0.945593,0.948142,
    0.950633,0.953065,0.955438,0.957752,0.960007,0.962203,0.964338,0.966414,
    0.968429,0.970384,0.972278,0.974111,0.975883,0.977593,0.979241,0.980828,
    0.982353,0.983816,0.985216,0.986554,0.987829,0.989041,0.990190,0.991277,
    0.992299,0.993259,0.994155,0.994988,0.995757,0.996462,0.997103,0.997680,
    0.998194,0.998643,0.999028,0.999350,0.999606,0.999799,0.999928,0.999992,
};

static float mel_bin_val[448] = {
    0.068442,0.253173,0.430483,0.600946,0.765070,0.923310,0.923926,0.776272,0.633398,0.495003,0.360816,0.230587,0.104091,
    0.076074,0.223728,0.366602,0.504997,0.639184,0.769413,0.895909,0.981118,0.861478,0.744995,0.631508,0.520865,0.412927,0.307566,0.204661,0.104100,0.005778,
    0.018882,0.138522,0.255005,0.368492,0.479135,0.587073,0.692434,0.795339,0.895900,0.994222,0.909600,0.815472,0.723310,0.633032,0.544563,0.457832,0.372773,0.289322,0.207419,0.127009,0.048037,
    0.090400,0.184528,0.276691,0.366968,0.455437,0.542167,0.627227,0.710678,0.792580,0.872991,0.951963,0.970452,0.894208,0.819258,0.745560,0.673071,0.601755,0.531572,0.462487,0.394466,0.327478,0.261492,0.196477,0.132405,0.069251,0.006987,
    0.029548,0.105792,0.180742,0.254440,0.326929,0.398245,0.468428,0.537513,0.605534,0.672522,0.738508,0.803523,0.867595,0.930749,0.993013,0.945589,0.885034,0.825298,0.766359,0.708197,0.650791,0.594123,0.538172,0.482923,0.428355,0.374454,0.321203,0.268588,0.216591,0.165200,0.114400,0.064179,0.014522,
    0.054411,0.114966,0.174702,0.233641,0.291803,0.349209,0.405877,0.461828,0.517077,0.571645,0.625546,0.678797,0.731412,0.783409,0.834800,0.885600,0.935821,0.985478,0.965418,0.916854,0.868819,0.821299,0.774287,0.727771,0.681738,0.636181,0.591090,0.546454,0.502265,0.458514,0.415193,0.372291,0.329804,0.287722,0.246037,0.204741,0.163828,0.123292,0.083123,0.043318,0.003868,
    0.034582,0.083146,0.131181,0.178701,0.225713,0.272229,0.318262,0.363819,0.408910,0.453546,0.497735,0.541486,0.584807,0.627709,0.670196,0.712278,0.753963,0.795259,0.836172,0.876708,0.916877,0.956682,0.996132,0.964767,0.926010,0.887590,0.849501,0.811739,0.774296,0.737169,0.700351,0.663837,0.627623,0.591705,0.556076,0.520732,0.485669,0.450882,0.416367,0.382120,0.348136,0.314413,0.280944,0.247728,0.214759,0.182036,0.149553,0.117307,0.085296,0.053513,0.021959,
    0.035233,0.073990,0.112410,0.150499,0.188261,0.225704,0.262831,0.299649,0.336163,0.372377,0.408295,0.443924,0.479268,0.514331,0.549118,0.583633,0.617880,0.651864,0.685587,0.719056,0.752272,0.785241,0.817964,0.850447,0.882693,0.914704,0.946487,0.978041,0.990628,0.959519,0.928627,0.897950,0.867485,0.837227,0.807177,0.777329,0.747683,0.718233,0.688979,0.659917,0.631047,0.602362,0.573863,0.545547,0.517412,0.489455,0.461674,0.434066,0.406630,0.379364,0.352264,0.325330,0.298560,0.271952,0.245502,0.219209,0.193072,0.167089,0.141260,0.115579,0.090047,0.064663,0.039422,0.014326,
    0.009372,0.040481,0.071373,0.102050,0.132516,0.162773,0.192823,0.222671,0.252317,0.281767,0.311021,0.340083,0.368953,0.397638,0.426137,0.454453,0.482588,0.510545,0.538326,0.565934,0.593370,0.620636,0.647736,0.674670,0.701440,0.728048,0.754498,0.780791,0.806928,0.832911,0.858740,0.884421,0.909953,0.935337,0.960578,0.985674,0.989372,0.964557,0.939883,0.915344,0.890942,0.866673,0.842537,0.818531,0.794657,0.770911,0.747292,0.723799,0.700429,0.677183,0.654058,0.631055,0.608171,0.585403,0.562754,0.540220,0.517801,0.495493,0.473300,0.451216,0.429242,0.407378,0.385621,0.363972,0.342427,0.320987,0.299651,0.278418,0.257286,0.236255,0.215324,0.194491,0.173756,0.153119,0.132577,0.112129,0.091776,0.071518,0.051352,0.031277,0.011294,
    0.010628,0.035443,0.060117,0.084656,0.109058,0.133327,0.157463,0.181469,0.205343,0.229089,0.252708,0.276201,0.299571,0.322817,0.345942,0.368945,0.391829,0.414597,0.437246,0.459780,0.482199,0.504507,0.526700,0.548784,0.570758,0.592622,0.614379,0.636028,0.657573,0.679013,0.700349,0.721582,0.742714,0.763745,0.784676,0.805509,0.826244,0.846881,0.867423,0.887871,0.908224,0.928482,0.948648,0.968723,0.988706,0.991399,0.971595,0.951878,0.932250,0.912709,0.893253,0.873883,0.854598,0.835396,0.816278,0.797242,0.778287,0.759414,0.740621,0.721908,0.703274,0.684719,0.666240,0.647839,0.629514,0.611265,0.593092,0.574992,0.556966,0.539014,0.521136,0.503327,0.485592,0.467927,0.450333,0.432808,0.415352,0.397967,0.380648,0.363397,0.346214,0.329098,0.312046,0.295061,0.278142,0.261286,0.244494,0.227767,0.211102,0.194499,0.177961,0.161482,0.145066,0.128710,0.112415,0.096179,0.080003,0.063887,0.047828,0.031828,0.015885,
};
static int16_t mel_bin_offset[10] = {
    1,7,14,24,35,50,68,91,119,155,
};
static int16_t mel_bin_len[10] = {
    13,17,21,26,33,41,51,64,81,101,
};

static float dct_weight[10*10] = {
    0.316228,0.316228,0.316228,0.316228,0.316228,0.316228,0.316228,0.316228,0.316228,0.316228,
    0.441708,0.398470,0.316228,0.203031,0.069960,-0.069960,-0.203031,-0.316228,-0.398470,-0.441708,
    0.425325,0.262866,0.000000,-0.262866,-0.425325,-0.425325,-0.262866,-0.000000,0.262866,0.425325,
    0.398470,0.069960,-0.316228,-0.441708,-0.203031,0.203031,0.441708,0.316228,-0.069960,-0.398470,
    0.361803,-0.138197,-0.447214,-0.138197,0.361803,0.361803,-0.138197,-0.447214,-0.138197,0.361803,
    0.316228,-0.316228,-0.316228,0.316228,0.316228,-0.316228,-0.316228,0.316228,0.316228,-0.316228,
    0.262866,-0.425325,-0.000000,0.425325,-0.262866,-0.262866,0.425325,0.000000,-0.425325,0.262866,
    0.203031,-0.441708,0.316228,0.069960,-0.398470,0.398470,-0.069960,-0.316228,0.441708,-0.203031,
    0.138197,-0.361803,0.447214,-0.361803,0.138197,0.138197,-0.361803,0.447214,-0.361803,0.138197,
    0.069960,-0.203031,0.316228,-0.398470,0.441708,-0.441708,0.398470,-0.316228,0.203031,-0.069960,
};
static float dct_lifter_coeffs[10] = {
    1.000000,2.565463,4.099058,5.569565,6.947049,8.203468,9.313246,10.253789,11.005952,11.554422,
};

static void remove_dc(float *wav) {
    float means = 0.0f;
    for(int i = 0; i < 512; i++) {
        means += wav[i];
    }
    means = means / 512.0f;
    for(int i = 0; i < 512; i++) {
        wav[i] = wav[i] - means;
    }
}

static float pre_point = 0.0f;
static void preemph(float* wav, int32_t len, float coeff) {
  float tmp_point = wav[len - 1];
  pre_point = 0.0f;
  for (int32_t i = len - 1; i > 0; i--) {
    wav[i] -= coeff * wav[i - 1];
  }
  wav[0] -= coeff * pre_point;
  pre_point = tmp_point;
}

static void windowing(float* wav, float *win) {
    float *win_ptr_f = win;
    float *win_ptr_b = win;
    float *wav_ptr_f = wav;
    float *wav_ptr_b = wav + 511;
    float tmp;
    for(int i = 0; i < 256; i++)
    {
        tmp = *wav_ptr_f;
        *wav_ptr_f++ = *win_ptr_f++ * tmp;
        tmp = *wav_ptr_b;
        *wav_ptr_b-- = *win_ptr_b++ * tmp;
    }
}

void get_mfcc_feature(float *frame, float *feature) {
    float tmp;
    float mel_bin[10];

    remove_dc(frame);

    preemph(frame, 512, 0.97f);

    windowing(frame, window_half);

    rdft512(frame, 1);

    frame[0] = frame[0] * frame[0];
    tmp = frame[1] * frame[1];
    for(int i = 1; i < 256; i++)
    {
        frame[i] = frame[2*i]*frame[2*i] + frame[2*i+1]*frame[2*i+1];
    }
    frame[256] = tmp;

    int16_t offset = 0;
    int16_t len = 0;
    float *val_ptr = mel_bin_val;
    for(int i = 0; i < 10; i++)
    {
        tmp = 0.0f;
        offset = mel_bin_offset[i];
        len = mel_bin_len[i];
        for(int j = 0; j < len; j++)
        {
            tmp += frame[offset + j] * (*val_ptr++);
        }
        mel_bin[i] = tmp;
    }
#define DBL_EPSILON 2.2204460492503131e-16
    for(int i = 0; i < 10; i++)
    {
        if(mel_bin[i] < DBL_EPSILON)
            mel_bin[i] = DBL_EPSILON;
        mel_bin[i] = logf(mel_bin[i]);
    }

    for(int i = 0; i < 10; i++)
    {
        tmp = 0.0f;
        for(int j = 0; j < 10; j++)
        {
            tmp += dct_weight[i*10 + j] * mel_bin[j];
        }
        feature[i] = tmp * dct_lifter_coeffs[i];
    }
}

